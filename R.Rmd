---
title: "Data Gathering"
author: "Mitch Lueken"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: html_document
---

```{r setup, echo = FALSE, message = FALSE}
library(tidyverse)
library(HelpersMG)
library(lubridate)
library(ggplot2)
library(kableExtra)
library(readxl)
library(haven)
```

```{r gimmeData, echo = FALSE, message = FALSE}
if(!file.exists("./raw_data/States-Cases.tsv")) {
  wget(url = "https://dataverse.harvard.edu/api/access/datafile/:persistentId?persistentId=doi:10.7910/DVN/HIDLTK/ROCWVZ", destfile = "./raw_data/States-Cases.tsv")
}
if(!file.exists("./raw_data/States-Deaths.tsv")) {
  wget(url = "https://dataverse.harvard.edu/api/access/datafile/:persistentId?persistentId=doi:10.7910/DVN/HIDLTK/DOK6EK", destfile = "./raw_data/States-Deaths.tsv")
}
if(!file.exists("./raw_data/States-Votes.xlsx")) {
  wget(url = "https://www.fec.gov/documents/1890/federalelections2016.xlsx", destfile = "./raw_data/States-Votes.xlsx", compression=none) # Gives corrupted file for some reason, manual download works fine
}
if(!file.exists("./raw_data/States-Governors.csv")) {
  wget(url = "https://github.com/luekenm/COVID-19/raw_data/States-Governors.csv", destfile = "./raw_data/States-Governors.csv")
}
if(!file.exists("./raw_data/LLCP2018.XPT")) {
  wget(url = "https://www.cdc.gov/brfss/annual_data/2018/files/LLCP2018XPT.zip", destfile = "./raw_data/LLCP2018XPT.zip")
  unzip("./raw_data/LLCP2018XPT.zip", exdir = "./raw_data")
  unlink("./raw_data/LLCP2018XPT.zip")
}
```

```{r covidData, echo = FALSE, message = FALSE}
dateButchery <- function(date) {
	return(mdy(paste(substr(date, 6, 7), "-", substr(date, 9, 10), "-", substr(date, 1, 4))))
}

tally <- function(column) {
  index = 1
	for(element in column) {
	  if(index > 1) {
        if(column[[index]] - column[[index - 1]] < 0) { # No negatives
          column[[index]] = 0
      } else {
          column[[index]] = column[[index]] - column[[index - 1]]
      }
    }
	    index = index + 1
  }
  	return(column)
}

cases <- read_tsv("./raw_data/States-Cases.tsv") %>%
  select(-c(fips, POP70, HHD70, POP80, HHD80, POP90, HHD90, POP00, HHD00, POP10, HHD10)) %>%
	pivot_longer(-NAME,
				 names_to = "Date",
				 values_to = "Total_Cases") %>%
	mutate(Date = dateButchery(Date))

read_tsv("./raw_data/States-Deaths.tsv") %>%
  select(-c(fips, POP70, HHD70, POP80, HHD80, POP90, HHD90, POP00, HHD00, HHD10)) %>%
	pivot_longer(-c(NAME, POP10),
				 names_to = "Date",
				 values_to = "Total_Deaths") %>%
	rename(Population = POP10) %>%
	mutate(Date = dateButchery(Date)) %>%
  right_join(cases, by = c("NAME", "Date")) %>%
  rename(State = NAME) %>%
  mutate(Daily_Cases = tally(Total_Cases),
         Daily_Deaths = tally(Total_Deaths),
         Per_Capita_Total_Cases = Total_Cases / Population,
         Per_Capita_Total_Deaths = Total_Deaths / Population,
         Per_Capita_Daily_Cases = Daily_Cases / Population,
         Per_Capita_Daily_Deaths = Daily_Deaths / Population) %>%
	write.table(file = "./output/States_COVID_data_by_date.csv", row.names = FALSE, sep = ",")
```

```{r electionData, echo = FALSE, message = FALSE}
margin <- function(trump, clinton) {
  index = 1
  for(votes in trump) {
    trump[[index]] = (trump[[index]] - clinton[[index]]) / (trump[[index]] + clinton[[index]])
    index = index + 1
  }
  return(trump)
}

read_excel("./raw_data/States-Votes.xlsx", sheet = "Table 2. Electoral &  Pop Vote") %>%
  select(1, 4, 5) %>%
  rename(State = 1, Trump = 2, Clinton = 3) %>%
  slice(4:54) %>%
  mutate(Trump = as.numeric(Trump), Clinton = as.numeric(Clinton)) %>%
  mutate(Margin = margin(Trump, Clinton)) %>%
  full_join(read_csv("./raw_data/States-Governors.csv"), by = "State") %>%
  write.table(file = "./output/States_info.csv", row.names = FALSE, sep = ",")
```

```{r healthData, echo = FALSE}
fipsTranslator <- function(column) {
  index = 1
  for(integer in column) {
    if(integer == 01) {
      column[[index]]="AL"
    } else if(integer == 02) {
      column[[index]]="AK"
    } else if(integer == 04) {
      column[[index]]="AZ"
    } else if(integer == 05) {
     column[[index]]="AR"
    } else if(integer == 06) {
      column[[index]]="CA"
    } else if(integer == 08) {
      column[[index]]="CO"
    } else if(integer == 09) {
      column[[index]]="CT"
    } else if(integer == 10) {
      column[[index]]="DE"
    } else if(integer == 11) {
      column[[index]]="DC"
    } else if(integer == 12) {
      column[[index]]="FL"
    } else if(integer == 13) {
      column[[index]]="GA"
    } else if(integer == 15) {
      column[[index]]="HI"
    } else if(integer == 16) {
      column[[index]]="ID"
    } else if(integer == 17) {
      column[[index]]="IL"
    } else if(integer == 18) {
      column[[index]]="IN"
    } else if(integer == 19) {
      column[[index]]="IA"
    } else if(integer == 20) {
      column[[index]]="KS"
    } else if(integer == 21) {
      column[[index]]="KY"
    } else if(integer == 22) {
      column[[index]]="LA"
    } else if(integer == 23) {
      column[[index]]="ME"
    } else if(integer == 24) {
      column[[index]]="MD"
    } else if(integer == 25) {
      column[[index]]="MA"
    } else if(integer == 26) {
      column[[index]]="MI"
    } else if(integer == 27) {
      column[[index]]="MN"
    } else if(integer == 28) {
      column[[index]]="MS"
    } else if(integer == 29) {
      column[[index]]="MO"
    } else if(integer == 30) {
      column[[index]]="MT"
    } else if(integer == 31) {
      column[[index]]="NE"
    } else if(integer == 32) {
      column[[index]]="NV"
    } else if(integer == 33) {
      column[[index]]="NH"
    } else if(integer == 34) {
      column[[index]]="NJ"
    } else if(integer == 35) {
      column[[index]]="NM"
    } else if(integer == 36) {
      column[[index]]="NY"
    } else if(integer == 37) {
      column[[index]]="NC"
    } else if(integer == 38) {
      column[[index]]="ND"
    } else if(integer == 39) {
      column[[index]]="OH"
    } else if(integer == 40) {
      column[[index]]="OK"
    } else if(integer == 41) {
      column[[index]]="OR"
    } else if(integer == 42) {
      column[[index]]="PA"
    } else if(integer == 44) {
      column[[index]]="RI"
    } else if(integer == 45) {
      column[[index]]="SC"
    } else if(integer == 46) {
      column[[index]]="SD"
    } else if(integer == 47) {
      column[[index]]="TN"
    } else if(integer == 48) {
      column[[index]]="TX"
    } else if(integer == 49) {
      column[[index]]="UT"
    } else if(integer == 50) {
      column[[index]]="VT"
    } else if(integer == 51) {
      column[[index]]="VA"
    } else if(integer == 53) {
      column[[index]]="WA"
    } else if(integer == 54) {
      column[[index]]="WV"
    } else if(integer == 55) {
      column[[index]]="WI"
    } else if(integer == 56) {
      column[[index]]="WY"
    } else {
      column[[index]]="NA"
    }
    index = index + 1
  }
  return(column)
}

hibble <- read_xpt("./raw_data/LLCP2018.XPT") %>%
  mutate(State = fipsTranslator(`_STATE`)) %>%
  filter(!State == "NA") %>%
  filter(STATERE1 == 1) %>%
  select(c(28:31,34:41,45,48:50,53,64,65,73,79,81:85,88,89,112,129,147,148,149,248,276)) %>% # Should also use weighting
  write.table(file = "./output/States_health.csv", row.names = FALSE, sep = ",")
```

```{r healthComputations, echo = FALSE}
read_csv("./output/States_health.csv") %>%
  filter(GENHLTH > 0) %>%
  filter(GENHLTH < 6) %>%
  group_by(State) %>%
  summarize(General_Health = mean(GENHLTH)) %>%
  arrange(desc(General_Health))
```

```{r dsafsa}
# State code to state string function
```

## Reference

1. China Data Lab, 2020, "US COVID-19 Daily Cases with Basemap", https://doi.org/10.7910/DVN/HIDLTK, Harvard Dataverse, V29, UNF:6:y1QAODHTEl8JQUjhLX6+Kw== [fileUNF]
1. Federal Election Commission
1. Wikipedia